---

variables:
  BASE_BRANCH_TAG_GL: $CI_REGISTRY_IMAGE/archlinux-base:$CI_COMMIT_SHORT_SHA
  BASE_BRANCH_TAG_QUAY: quay.io/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAMESPACE/archlinux-base:$CI_COMMIT_SHORT_SHA

.setup: &setup |
  mkdir -p /run/containers/$UID/
  echo "$REG_AUTH_JSON" > /run/containers/$UID/auth.json

stages:
  - ğŸ“¦ build
  - ğŸš€ deploy

build_base:
  stage: ğŸ“¦ build
  image:
    name: quay.io/buildah/stable:v1.21.0
  before_script:
    - *setup
    - echo "UPSTREAM_TAG=$(grep 'FROM' < $CI_PROJECT_DIR/$CONTAINER_ROOT/Containerfile | sed -e 's#FROM docker.io/library/archlinux\:##g' -e 's#base.##g')"
  script:
    - buildah bud --format docker -f $CI_PROJECT_DIR/$CONTAINER_ROOT/Containerfile -t $BASE_BRANCH_TAG_GL -t #BASE_BRANCH_TAG_QUAY $CI_PROJECT_DIR/$CONTAINER_ROOT
    - buildah push -t $BASE_BRANCH_TAG_GL -t $BASE_BRANCH_TAG_QUAY
  only:
    - branches
  variables:
    CONTAINER_ROOT: "/images/archlinux/"

release:
  image: node:12-buster-slim
  stage: ğŸš€ deploy
  before_script:
    - 'which git || ( apt update && apt-get install -qq git )'
    - npm install -g semantic-release @semantic-release/gitlab
  script:
    - semantic-release
  only:
    - master
    - branches
  tags:
    - kutara-cloud
