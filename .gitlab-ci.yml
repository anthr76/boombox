---

variables:
  BASE_BRANCH_TAGS: -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -t quay.io/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAMESPACE

.auth_setup: &auth_setup |
  mkdir -p /run/containers/$UID/
  echo "$REG_AUTH_JSON" > /run/containers/$UID/auth.json

stages:
  - ðŸ“¦ build
  - ðŸš€ deploy

build_base:
  stage: ðŸ“¦ build
  image:
    name: quay.io/buildah/stable:v1.21.0
  script:
    - *auth_setup
    - buildah bud --format docker -f $CI_PROJECT_DIR/$CONTAINER_ROOT/Containerfile -t $BASE_BRANCH_TAGS $CI_PROJECT_DIR/$CONTAINER_ROOT
    - buildah push $BASE_BRANCH_TAGS
  only:
    - branches
  variables:
    CONTAINER_ROOT: "/images/archlinux/"

release:
  image: node:12-buster-slim
  stage: ðŸš€ deploy
  before_script:
    - 'which git || ( apt update && apt-get install -qq git )'
    - npm install -g semantic-release @semantic-release/gitlab
  script:
    - semantic-release
  only:
    - master
    - branches
  tags:
    - kutara-cloud
