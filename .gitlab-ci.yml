---
stages:
  - ðŸ“¦ build
  - ðŸš€ deploy

build:
  stage: ðŸ“¦ build
  image:
    name: quay.io/buildah/stable:v1.21.0
  before_script:
    - mkdir -p /run/containers/$UID/
    - echo "$REG_AUTH_JSON" > /run/containers/$UID/auth.json
    - dnf reinstall shadow-utils
  script:
    - buildah bud --format docker -f $CI_PROJECT_DIR/$CONTAINER_ROOT/Containerfile -t $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG $CONTAINER_ROOT
    - buildah push
  only:
    - branches
  parallel:
    matrix:
      - CONTAINER_ROOT: ["/images/archlinux/"]
  tags:
   - kutara-cloud


release:
  image: node:12-buster-slim
  stage: ðŸš€ deploy
  before_script:
    - 'which git || ( apt update && apt-get install -qq git )'
    - npm install -g semantic-release @semantic-release/gitlab
  script:
    - semantic-release
  only:
    - master
    - branches
