---

stages:
  - 📦 build
  - ♻️ push build
  - 🧹 cleanup
  - ✨ lint
  - 🚑 scan
  - 🚀 deploy
  - 🚀 release

include:
  - project: 'kutara/gitlab-ci-templates'
    ref: master
    file:
      - 'templates/container-build.yml'
      - 'templates/semantic-release.yml'

.buildah:
  image: quay.io/buildah/stable:v1.21.0
  extends:
    - .container build
  variables:
    - ARCH: amd64
  script:
    - echo "Building ${GL_BUILD_TAG} ${QUAY_BUILD_TAG} using ${CONTAINER_DIR}/${CONTAINERFILE_NAME}"
    - mkdir -p /run/containers/$UID/
    - echo "$DOCKERCFG" > /run/containers/$UID/auth.json
    - export fed_ver=$(echo $FGC | tr -d f)
    - mkdir -p /var/cache/dnf/$fed_ver
    - buildah bud --arch="$ARCH" --build-arg=BUILDPLATFORM=linux/$ARCH --build-arg=TARGETPLATFORM=linux/$ARCH -v /var/cache/dnf/$fed_ver:/var/cache/dnf/$fed_ver:O -f $CI_PROJECT_DIR/$CONTAINER_DIR/$CONTAINERFILE_NAME -t $GL_BUILD_TAG -t $QUAY_BUILD_TAG $CI_PROJECT_DIR/$CONTAINER_DIR
    - buildah push -f oci --tls-verify=false $GL_BUILD_TAG
    - buildah push $QUAY_BUILD_TAG
    - mkdir -p build
    - buildah push -f docker $GL_BUILD_TAG oci:build/image
  parallel:
    matrix:
      - CONTAINER_DIR:
        - images/shim
        - images/archlinux
  cache:
    paths:
      - /var/cache/dnf
  artifacts:
    paths:
      - build/amd64


.deploy:
  script:
    - mkdir -p /run/containers/$UID/
    - echo "$DOCKERCFG" > /run/containers/$UID/auth.json
    - export REGISTRY_AUTH_FILE=$(echo /run/containers/$UID/auth.json)
    - skopeo inspect oci:build/image
    - skopeo copy --all -f v2s2 oci:build/image docker://$GL_LATEST_TAG
    - skopeo copy --all -f v2s2 oci:build/image docker://$GL_RELEASE_TAG
    - skopeo copy --all oci:build/image docker://$QUAY_LATEST_TAG
    - skopeo copy --all oci:build/image docker://$QUAY_RELEASE_TAG
    - UPSTREAM_VERSION=$(cat build/upstream-version)
    - skopeo copy --all -f v2s2 oci:build/image docker://$CI_REGISTRY_IMAGE:$UPSTREAM_VERSION
    - skopeo copy --all oci:build/image docker://quay.io/$CI_PROJECT_ROOT_NAMESPACE/$CI_PROJECT_NAME:$UPSTREAM_VERSION
