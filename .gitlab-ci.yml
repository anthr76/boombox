---

variables:
  REG_BASE_NS_GL: $CI_REGISTRY_IMAGE/archlinux-base
  REG_NS_QUAY: quay.io/$CI_PROJECT_NAMESPACE/toolbox-archlinux-base

.setup: &setup |
  mkdir -p /run/containers/$UID/
  echo "$REG_AUTH_JSON" > /run/containers/$UID/auth.json

stages:
  - ðŸ“¦ build
  - ðŸš€ deploy

build_base:
  stage: ðŸ“¦ build
  # rules:
  #   - changes:
  #       - .gitlab-ci.yml
  #       - $CONTAINER_ROOT/**/*
  image:
    name: quay.io/buildah/stable:v1.21.0
  before_script:
    - *setup
  script:
    - buildah bud --format docker -f $CI_PROJECT_DIR/$CONTAINER_ROOT/Containerfile -t $REG_BASE_NS_GL:$CI_COMMIT_SHORT_SHA -t $REG_NS_QUAY:$CI_COMMIT_SHORT_SHA $CI_PROJECT_DIR/$CONTAINER_ROOT
    - buildah push --tls-verify=false $REG_BASE_NS_GL:$CI_COMMIT_SHORT_SHA
    - buildah push $REG_NS_QUAY:$CI_COMMIT_SHORT_SHA
  only:
    - branches
  variables:
    CONTAINER_ROOT: "/images/archlinux/"

release:
  image: node:12-buster-slim
  stage: ðŸš€ deploy
  before_script:
    - 'which git || ( apt update && apt-get install -qq git )'
    - npm install -g semantic-release @semantic-release/gitlab
  script:
    - semantic-release
  only:
    - master
    - branches
  tags:
    - kutara-cloud
